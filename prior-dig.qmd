---
title: "Prior digoxin use"
editor: source
code-fold: true
editor_options: 
  chunk_output_type: console
---

```{r}
suppressPackageStartupMessages({
  library(dplyr)
  library(gtsummary)
  library(survival)
})

tar_load <- targets::tar_load

tar_load(lista_zmiennych)
tar_load(df_trtmt)


tar_load(dd_df_trmnt)
options(datadist = "dd_df_trmnt")  # for the rms package setup

dwhf_surv <- with(df_trtmt, Surv(dwhfdays,dwhf))
```

# Wprowadzenie

Celem niniejszej analizy jest ocena, czy wcześniejsze stosowanie digoksyny przed randomizacją miało wpływ na wyniki kliniczne pacjentów leczonych digoksyną w ramach badania DIG. W szczególności analizujemy, czy pacjenci z wcześniejszą ekspozycją na digoksynę różnią się pod względem ryzyka zgonu lub hospitalizacji z powodu niewydolności serca w porównaniu do pacjentów, którzy nie przyjmowali wcześniej digoksyny.

Z medycznego punktu widzenia istotne jest, czy długotrwałe stosowanie digoksyny może prowadzić do zmniejszenia skuteczności leku (np. poprzez rozwój tolerancji farmakologicznej) lub zwiększać ryzyko działań niepożądanych. 

Pacjenci wcześniej leczeni digoksyną mogą stanowić populację o bardziej zaawansowanej lub trudniejszej do kontrolowania niewydolności serca, co może wpływać na rokowanie niezależnie od leczenia w ramach badania.

Ze względu na brak randomizacji względem wcześniejszego stosowania digoksyny, zastosowanie metody propensity score matching pozwala zredukować wpływ czynników zakłócających (confounding by indication) i umożliwia bardziej wiarygodne porównanie wyników pomiędzy grupami.

# Propensity score model

```{r}
ps_model_forumla <- as.formula("diguse ~ age + sex + race + ejf_per * chestx + bmi + functcls + diuret + aceinhib + prevmi + diabetes + hyperten")

ps_model <- glm(ps_model_forumla, data = df_trtmt, family = binomial)

concordance(ps_model)

cat("AIC =",AIC(ps_model))

cat("BIC =", BIC(ps_model))
```

```{r}
ps_model %>% 
  tbl_regression(
    exponentiate = TRUE, 
    tidy_fun = broom.helpers::tidy_parameters, 
    intercept=TRUE)
```

# Matching 

```{r}
df_trtmt$pscore <- predict(ps_model, type = "response")

matchit_obj <- MatchIt::matchit(diguse ~ pscore,
                       data = df_trtmt, method = "nearest", ratio = 1, caliper = 0.1)

df_matched <- MatchIt::match.data(matchit_obj)
```


## Matching evaluation

```{r}
summary(matchit_obj)
plot(matchit_obj, type = "qq")
#love.plot(matchit_obj)
```

### Pre-matching

```{r}
ps_model_predictors <-  all.vars(formula(ps_model_forumla)[[3]])  # right-hand side variables of the formula

df_trtmt %>%
  select(all_of(ps_model_predictors), diguse) %>%
  tbl_summary(by = diguse, statistic = all_continuous() ~ "{mean} ± {sd}", missing = "no") %>%
  add_difference() 
```

### Post-Matching 

```{r}
ps_model_predictors <-  all.vars(formula(ps_model_forumla)[[3]])  # right-hand side variables of the formula

df_matched %>%
  select(all_of(ps_model_predictors), diguse) %>%
  tbl_summary(by = diguse, statistic = all_continuous() ~ "{mean} ± {sd}", missing = "no") %>%
  add_difference()
```

# Cox model on matched data

```{r}

dwhf_surv_matched <- with(df_matched, Surv(dwhfdays,dwhf))

cox_matched <- rms::cph(dwhf_surv_matched ~ diguse, data = df_matched, x = TRUE, y = TRUE, surv = TRUE)

HR <- exp(coef(cox_matched))
HR_ci95lo <- exp(confint(cox_matched)[1])
HR_ci95hi <- exp(confint(cox_matched)[2])

summary(cox_matched)
```

* Hazard Ratio (HR) = `{r} signif(HR, digits=3)` --- 
Pacjenci, którzy stosowali digoksynę przed randomizacją, mieli o `{r round(100*(HR-1), 0)}` wyższe ryzyko zgonu lub hospitalizacji z powodu niewydolności serca w porównaniu do pacjentów, którzy nie stosowali jej wcześniej.

* 95% przedział ufności: `{r} signif(HR_ci95lo, digits=3)` – `{r} signif(HR_ci95hi, digits=3)`  --- Przedział nie obejmuje 1 — efekt jest statystycznie istotny.

```{r}
fit <- survival::survfit(cox_matched, newdata = data.frame(diguse = levels(df_matched$diguse)))

# Plot
survminer::ggsurvplot(
  fit,
  data = df_matched,
  fun = 'event',
  legend.labs = levels(df_matched$diguse),
  legend.title = "Digoxin use before trial",
  xlab = "Time (days)",
  ylab = "Survival probability",
  ggtheme = ggplot2::theme_minimal()
)
```

# Wnioski

Wynik wskazuje na potencjalnie gorsze rokowanie u pacjentów z wcześniejszym stosowaniem digoksyny, nawet po dopasowaniu względem cech wyjściowych tj. zaawansowanie HF.
